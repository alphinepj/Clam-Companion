<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Create your Calm Companion account - Start your wellness journey">
    <title>üåø Register | Calm Companion</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#4A7C59">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåø</text></svg>">
</head>
<body>
    <div class="form-container fade-in">
        <div class="form-header">
            <h1>üåø Join Calm Companion</h1>
            <p>Create your account and begin your journey to inner peace</p>
        </div>
        
        <form id="register-form" class="auth-form">
            <div class="form-group">
                <label for="register-email">Email Address</label>
                <input 
                    type="email" 
                    id="register-email" 
                    name="email"
                    placeholder="Enter your email address" 
                    required
                    autocomplete="email"
                >
                <div class="field-error"></div>
            </div>
            
            <div class="form-group">
                <label for="register-password">Password</label>
                <input 
                    type="password" 
                    id="register-password" 
                    name="password"
                    placeholder="Create a secure password (min. 6 characters)" 
                    required
                    autocomplete="new-password"
                >
                <div class="field-error"></div>
                <div class="password-strength" id="password-strength"></div>
            </div>
            
            <div class="form-group">
                <label for="confirm-password">Confirm Password</label>
                <input 
                    type="password" 
                    id="confirm-password" 
                    name="confirmPassword"
                    placeholder="Confirm your password" 
                    required
                    autocomplete="new-password"
                >
                <div class="field-error"></div>
            </div>
            
            <button type="submit" id="register-button" class="btn-primary">
                <span class="btn-text">Create Account</span>
                <span class="btn-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    Creating account...
                </span>
            </button>
        </form>
        
        <div class="form-footer">
            <p>Already have an account? <a href="login.html">Sign in</a></p>
            <a href="index.html" class="back-link">‚Üê Back to Home</a>
        </div>
        
        <div id="error-message" class="error-message" style="display: none;">
            <span id="error-text"></span>
        </div>
    </div>

    <script>
        class RegisterManager {
            constructor() {
                this.apiBaseUrl = 'http://localhost:5000/api';
                this.form = document.getElementById('register-form');
                this.emailInput = document.getElementById('register-email');
                this.passwordInput = document.getElementById('register-password');
                this.confirmPasswordInput = document.getElementById('confirm-password');
                this.submitButton = document.getElementById('register-button');
                this.errorMessage = document.getElementById('error-message');
                this.errorText = document.getElementById('error-text');
                this.passwordStrength = document.getElementById('password-strength');
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.focusFirstInput();
            }
            
            setupEventListeners() {
                this.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleRegister();
                });
                
                // Real-time validation
                this.emailInput.addEventListener('input', () => {
                    this.validateEmail();
                });
                
                this.passwordInput.addEventListener('input', () => {
                    this.validatePassword();
                    this.updatePasswordStrength();
                });
                
                this.confirmPasswordInput.addEventListener('input', () => {
                    this.validateConfirmPassword();
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.hideError();
                    }
                });
            }
            
            focusFirstInput() {
                setTimeout(() => {
                    this.emailInput.focus();
                }, 100);
            }
            
            validateEmail() {
                const email = this.emailInput.value.trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (email && !emailRegex.test(email)) {
                    this.showFieldError(this.emailInput, 'Please enter a valid email address');
                    return false;
                } else {
                    this.clearFieldError(this.emailInput);
                    return true;
                }
            }
            
            validatePassword() {
                const password = this.passwordInput.value;
                
                if (password && password.length < 6) {
                    this.showFieldError(this.passwordInput, 'Password must be at least 6 characters');
                    return false;
                } else {
                    this.clearFieldError(this.passwordInput);
                    return true;
                }
            }
            
            validateConfirmPassword() {
                const password = this.passwordInput.value;
                const confirmPassword = this.confirmPasswordInput.value;
                
                if (confirmPassword && password !== confirmPassword) {
                    this.showFieldError(this.confirmPasswordInput, 'Passwords do not match');
                    return false;
                } else {
                    this.clearFieldError(this.confirmPasswordInput);
                    return true;
                }
            }
            
            updatePasswordStrength() {
                const password = this.passwordInput.value;
                let strength = 0;
                let message = '';
                let className = '';
                
                if (password.length >= 6) strength++;
                if (password.length >= 8) strength++;
                if (/[a-z]/.test(password)) strength++;
                if (/[A-Z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                
                switch (strength) {
                    case 0:
                    case 1:
                        message = 'Very Weak';
                        className = 'very-weak';
                        break;
                    case 2:
                        message = 'Weak';
                        className = 'weak';
                        break;
                    case 3:
                        message = 'Fair';
                        className = 'fair';
                        break;
                    case 4:
                        message = 'Good';
                        className = 'good';
                        break;
                    case 5:
                        message = 'Strong';
                        className = 'strong';
                        break;
                    case 6:
                        message = 'Very Strong';
                        className = 'very-strong';
                        break;
                }
                
                if (password) {
                    this.passwordStrength.textContent = message;
                    this.passwordStrength.className = `password-strength ${className}`;
                    this.passwordStrength.style.display = 'block';
                } else {
                    this.passwordStrength.style.display = 'none';
                }
            }
            
            showFieldError(input, message) {
                input.classList.add('error');
                const errorDiv = input.parentNode.querySelector('.field-error');
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                }
            }
            
            clearFieldError(input) {
                input.classList.remove('error');
                const errorDiv = input.parentNode.querySelector('.field-error');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
            }
            
            async handleRegister() {
                const email = this.emailInput.value.trim();
                const password = this.passwordInput.value;
                const confirmPassword = this.confirmPasswordInput.value;
                
                // Validate inputs
                if (!email || !password || !confirmPassword) {
                    this.showError('Please fill in all fields');
                    return;
                }
                
                if (!this.validateEmail() || !this.validatePassword() || !this.validateConfirmPassword()) {
                    return;
                }
                
                this.setLoading(true);
                this.hideError();
                
                try {
                    const response = await this.makeRequest(`${this.apiBaseUrl}/auth/register`, {
                        method: 'POST',
                        body: JSON.stringify({ email, password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Store token and user data if provided
                        if (data.token) {
                            localStorage.setItem('token', data.token);
                        }
                        if (data.user) {
                            localStorage.setItem('userProfile', JSON.stringify(data.user));
                        }
                        
                        // Show success message
                        this.showSuccess('Account created successfully! Welcome to Calm Companion üåø');
                        
                        // Redirect after a short delay
                        setTimeout(() => {
                            if (data.token) {
                                window.location.href = 'index.html';
                            } else {
                                window.location.href = 'login.html';
                            }
                        }, 2000);
                        
                    } else {
                        this.handleRegisterError(data);
                    }
                    
                } catch (error) {
                    console.error('Registration failed:', error);
                    this.showError('Connection failed. Please check your internet and try again.');
                } finally {
                    this.setLoading(false);
                }
            }
            
            handleRegisterError(data) {
                const errorMessages = {
                    'VALIDATION_ERROR': 'Please check your input and try again.',
                    'INVALID_EMAIL': 'Please enter a valid email address.',
                    'WEAK_PASSWORD': 'Password must be at least 6 characters long.',
                    'USER_EXISTS': 'An account with this email already exists.',
                    'SERVER_ERROR': 'Server error. Please try again later.',
                    'RATE_LIMIT_EXCEEDED': 'Too many registration attempts. Please wait a moment.'
                };
                
                const message = errorMessages[data.code] || data.error || 'Registration failed. Please try again.';
                this.showError(message);
            }
            
            async makeRequest(url, options = {}) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal,
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        }
                    });
                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('Request timeout');
                    }
                    throw error;
                }
            }
            
            setLoading(loading) {
                const btnText = this.submitButton.querySelector('.btn-text');
                const btnLoading = this.submitButton.querySelector('.btn-loading');
                
                this.submitButton.disabled = loading;
                this.emailInput.disabled = loading;
                this.passwordInput.disabled = loading;
                this.confirmPasswordInput.disabled = loading;
                
                if (loading) {
                    btnText.style.display = 'none';
                    btnLoading.style.display = 'flex';
                    btnLoading.style.alignItems = 'center';
                    btnLoading.style.gap = '0.5rem';
                } else {
                    btnText.style.display = 'inline';
                    btnLoading.style.display = 'none';
                }
            }
            
            showError(message) {
                this.errorText.textContent = message;
                this.errorMessage.style.display = 'block';
                this.errorMessage.className = 'error-message error';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    this.hideError();
                }, 5000);
            }
            
            showSuccess(message) {
                this.errorText.textContent = message;
                this.errorMessage.style.display = 'block';
                this.errorMessage.className = 'error-message success';
            }
            
            hideError() {
                this.errorMessage.style.display = 'none';
            }
        }
        
        // Initialize register manager when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new RegisterManager();
        });
    </script>
</body>
</html>
